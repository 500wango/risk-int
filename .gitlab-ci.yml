# GitLab CI/CD 配置
stages:
  - test
  - build
  - deploy

variables:
  DOCKER_IMAGE: $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA
  DOCKER_IMAGE_LATEST: $CI_REGISTRY_IMAGE:latest

# ============================================
# 代码检查和测试
# ============================================
test:
  stage: test
  image: python:3.10-slim
  services:
    - postgres:14
  variables:
    POSTGRES_DB: test_db
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: postgres
    DATABASE_URL: postgresql+asyncpg://postgres:postgres@postgres:5432/test_db
  before_script:
    - apt-get update && apt-get install -y libnss3 libatk-bridge2.0-0 libdrm2 libxkbcommon0 libgbm1
    - pip install --upgrade pip
    - pip install -r requirements.txt
    - pip install pytest pytest-asyncio httpx ruff
    - playwright install chromium
  script:
    - ruff check app/ --ignore E501
    - pytest tests/ -v --tb=short || echo "No tests found"
  only:
    - merge_requests
    - main
    - master

# ============================================
# 构建 Docker 镜像
# ============================================
build:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build -t $DOCKER_IMAGE -t $DOCKER_IMAGE_LATEST .
    - docker push $DOCKER_IMAGE
    - docker push $DOCKER_IMAGE_LATEST
  only:
    - main
    - master

# ============================================
# 部署到测试环境
# ============================================
deploy_staging:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client curl
    - eval $(ssh-agent -s)
    - echo "$STAGING_SSH_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh && chmod 700 ~/.ssh
    - echo "$STAGING_SSH_KNOWN_HOSTS" >> ~/.ssh/known_hosts
  script:
    - |
      ssh $STAGING_USER@$STAGING_HOST << 'EOF'
        cd /opt/risk_intel
        docker pull $CI_REGISTRY_IMAGE:latest
        docker-compose down || true
        docker-compose up -d
        docker image prune -f
      EOF
    - sleep 30
    - curl -f $STAGING_URL/api/source/list
  environment:
    name: staging
    url: $STAGING_URL
  only:
    - main
    - master
  when: manual

# ============================================
# 部署到生产环境
# ============================================
deploy_production:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client curl
    - eval $(ssh-agent -s)
    - echo "$PROD_SSH_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh && chmod 700 ~/.ssh
    - echo "$PROD_SSH_KNOWN_HOSTS" >> ~/.ssh/known_hosts
  script:
    - |
      ssh $PROD_USER@$PROD_HOST << 'EOF'
        cd /opt/risk_intel
        
        # 备份数据库
        docker exec risk_intel_db_1 pg_dump -U postgres risk_db > backup_$(date +%Y%m%d_%H%M%S).sql
        
        # 更新应用
        docker pull $CI_REGISTRY_IMAGE:latest
        docker-compose down
        docker-compose up -d
        docker image prune -f
      EOF
    - sleep 30
    - curl -f $PROD_URL/api/source/list
  environment:
    name: production
    url: $PROD_URL
  only:
    - main
    - master
  when: manual
  needs:
    - deploy_staging
